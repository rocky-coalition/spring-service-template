- pipeline: "spring-service-template"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "refs/heads/*"
  ref_type: "WILDCARD"
  trigger_condition: "ALWAYS"
  actions:
    - action: "Execute: gradle build test"
      type: "BUILD"
      working_directory: "/buddy/spring-service-template"
      docker_image_name: "library/gradle"
      docker_image_tag: "6.3.0-jdk14"
      execute_commands:
        - "gradle build test"
      volume_mappings:
        - "/:/buddy/spring-service-template"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Set SHOULD_BUILD_IMAGE variable"
      type: "BUILD"
      working_directory: "/buddy/spring-service-template"
      docker_image_name: "library/ubuntu"
      docker_image_tag: "18.04"
      execute_commands:
        - "if echo \"${BUDDY_EXECUTION_BRANCH}\" | egrep 'master|staging|production' >/dev/null 2>&1"
        - "then"
        - "    export SHOULD_BUILD_IMAGE=\"true\""
        - "else"
        - "    export SHOULD_BUILD_IMAGE=\"false\""
        - "fi"
      volume_mappings:
        - "/:/buddy/spring-service-template"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Build Docker image"
      type: "DOCKERFILE"
      region: "us-west-2"
      docker_image_tag: "$BUDDY_EXECUTION_REVISION"
      dockerfile_path: "Dockerfile"
      repository: "$ECR_REPO"
      do_not_prune_images: true
      trigger_condition: "VAR_IS"
      trigger_variable_value: "true"
      trigger_variable_key: "SHOULD_BUILD_IMAGE"
      integration_id: 62974
    - action: "Execute: ./deploy.sh on master, staging, production"
      type: "BUILD"
      working_directory: "/buddy/spring-service-template"
      docker_image_name: "library/python"
      docker_image_tag: "3.6.0"
      execute_commands:
        - "pip install --no-cache awscli"
        - "aws s3 cp s3://coalition-deployment/deploy.sh deploy.sh"
        - "chmod +x deploy.sh"
        - ""
        - "case $BUDDY_EXECUTION_BRANCH in"
        - "  master)"
        - "    ./deploy.sh"
        - "    ;;"
        - "  staging)"
        - "    DEPLOY_ENVIRONMENT_NAMES=staging2 OVERRIDE_BRANCH_NAME=staging2 ./deploy.sh"
        - "    ;;"
        - "  production)"
        - "    DEPLOY_ENVIRONMENT_NAMES=production,demo2 ./deploy.sh"
        - "    ;;"
        - "  *) echo \"Not executing deploy.sh for ${BUDDY_EXECUTION_BRANCH}\";;"
        - "esac"
      volume_mappings:
        - "/:/buddy/spring-service-template"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Send failure notification to back-end-ci channel"
      type: "SLACK"
      trigger_time: "ON_FAILURE"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
      blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Failed execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
      channel: "CQK4UN6DP"
      channel_name: "back-end-ci"
      trigger_condition: "ALWAYS"
      integration_hash: "5ea84596422f5a5a7fb4d8f4"
    - action: "Send  success notification to back-end-ci channel"
      type: "SLACK"
      trigger_time: "ON_BACK_TO_SUCCESS"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
      blocks: "[{\"type\":\"section\",\"fields\":[{\"type\":\"mrkdwn\",\"text\":\"*Successful execution:* <$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\"},{\"type\":\"mrkdwn\",\"text\":\"*Pipeline:* <$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\"},{\"type\":\"mrkdwn\",\"text\":\"*Branch:* $BUDDY_EXECUTION_BRANCH\"},{\"type\":\"mrkdwn\",\"text\":\"*Project:* <$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\"}]}]"
      channel: "CQK4UN6DP"
      channel_name: "back-end-ci"
      trigger_condition: "ALWAYS"
      integration_hash: "5ea84596422f5a5a7fb4d8f4"
  variables:
    - key: "ECR_REPO"
      value: "distribution/spring-service-template"
      id: 358801
      description: ""
    - key: "IMAGE_NAME"
      value: "079622674598.dkr.ecr.us-west-2.amazonaws.com/distribution/spring-service-template"
      id: 358802
      description: ""
    - key: "SHOULD_BUILD_IMAGE"
      value: "true"
      id: 358805
      settable: true
      description: ""
